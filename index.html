<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>FieldSketch</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div id="app">
        <!-- Top Toolbar -->
        <header id="toolbar">
            <div class="toolbar-group toolbar-left">
                <button id="btn-menu" class="toolbar-btn" title="Menu">
                    <svg width="20" height="20" viewBox="0 0 20 20"><path d="M3 5h14M3 10h14M3 15h14" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round"/></svg>
                </button>
                <span class="app-title">FieldSketch</span>
                <span id="project-name" class="project-name">Untitled</span>
            </div>
            <div class="toolbar-group toolbar-center">
                <!-- Drawing Tools -->
                <button class="toolbar-btn tool-btn active" data-tool="select" title="Select (V)">
                    <svg width="20" height="20" viewBox="0 0 20 20"><path d="M4 2l10 8-4.5 1L7 16z" stroke="currentColor" stroke-width="1.2" fill="none"/></svg>
                </button>
                <button class="toolbar-btn tool-btn" data-tool="line" title="Line (L)">
                    <svg width="20" height="20" viewBox="0 0 20 20"><line x1="3" y1="17" x2="17" y2="3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
                </button>
                <button class="toolbar-btn tool-btn" data-tool="rect" title="Rectangle (R)">
                    <svg width="20" height="20" viewBox="0 0 20 20"><rect x="3" y="4" width="14" height="12" stroke="currentColor" stroke-width="1.2" fill="none" rx="1"/></svg>
                </button>
                <button class="toolbar-btn tool-btn" data-tool="circle" title="Circle (C)">
                    <svg width="20" height="20" viewBox="0 0 20 20"><circle cx="10" cy="10" r="7" stroke="currentColor" stroke-width="1.2" fill="none"/></svg>
                </button>
                <button class="toolbar-btn tool-btn" data-tool="arc" title="Arc (A)">
                    <svg width="20" height="20" viewBox="0 0 20 20"><path d="M4 16 Q4 4 16 4" stroke="currentColor" stroke-width="1.2" fill="none" stroke-linecap="round"/></svg>
                </button>
                <button class="toolbar-btn tool-btn" data-tool="polyline" title="Polyline (P)">
                    <svg width="20" height="20" viewBox="0 0 20 20"><polyline points="3,16 7,6 13,14 17,4" stroke="currentColor" stroke-width="1.2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
                <button class="toolbar-btn tool-btn" data-tool="freehand" title="Freehand (F)">
                    <svg width="20" height="20" viewBox="0 0 20 20"><path d="M3 14 Q6 6 10 10 Q14 14 17 6" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round"/></svg>
                </button>
                <div class="toolbar-separator"></div>
                <button class="toolbar-btn tool-btn" data-tool="dimension" title="Dimension (D)">
                    <svg width="20" height="20" viewBox="0 0 20 20"><line x1="3" y1="14" x2="17" y2="14" stroke="currentColor" stroke-width="1"/><line x1="3" y1="11" x2="3" y2="17" stroke="currentColor" stroke-width="1"/><line x1="17" y1="11" x2="17" y2="17" stroke="currentColor" stroke-width="1"/><path d="M5 14l-2-1.5M5 14l-2 1.5M15 14l2-1.5M15 14l2 1.5" stroke="currentColor" stroke-width="0.8"/><text x="10" y="12" text-anchor="middle" font-size="7" fill="currentColor">12.5</text></svg>
                </button>
                <button class="toolbar-btn tool-btn" data-tool="text" title="Text (T)">
                    <svg width="20" height="20" viewBox="0 0 20 20"><text x="10" y="15" text-anchor="middle" font-size="14" font-weight="bold" fill="currentColor">T</text></svg>
                </button>
                <button class="toolbar-btn tool-btn" data-tool="callout" title="Callout">
                    <svg width="20" height="20" viewBox="0 0 20 20"><rect x="3" y="3" width="12" height="8" rx="1" stroke="currentColor" stroke-width="1" fill="none"/><polyline points="8,11 6,16 10,11" stroke="currentColor" stroke-width="1" fill="none"/></svg>
                </button>
                <button class="toolbar-btn tool-btn" data-tool="arrow" title="Arrow">
                    <svg width="20" height="20" viewBox="0 0 20 20"><line x1="3" y1="17" x2="16" y2="4" stroke="currentColor" stroke-width="1.5"/><polyline points="11,3 17,3 17,9" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
                <button class="toolbar-btn tool-btn" data-tool="symbol" title="Symbol">
                    <svg width="20" height="20" viewBox="0 0 20 20"><circle cx="10" cy="8" r="4" stroke="currentColor" stroke-width="1" fill="none"/><line x1="10" y1="12" x2="10" y2="18" stroke="currentColor" stroke-width="1"/><line x1="7" y1="15" x2="13" y2="15" stroke="currentColor" stroke-width="1"/></svg>
                </button>
                <div class="toolbar-separator"></div>
                <button class="toolbar-btn tool-btn" data-tool="eraser" title="Eraser (E)">
                    <svg width="20" height="20" viewBox="0 0 20 20"><path d="M7 17h10M4.5 14.5l8-8 3 3-8 8-3.5.5z" stroke="currentColor" stroke-width="1.2" fill="none"/></svg>
                </button>
            </div>
            <div class="toolbar-group toolbar-right">
                <div class="toolbar-control">
                    <label>Color</label>
                    <input type="color" id="stroke-color" value="#000000" title="Stroke Color">
                </div>
                <div class="toolbar-control">
                    <label>Width</label>
                    <select id="stroke-width">
                        <option value="1">1px</option>
                        <option value="2" selected>2px</option>
                        <option value="3">3px</option>
                        <option value="4">4px</option>
                        <option value="6">6px</option>
                        <option value="8">8px</option>
                    </select>
                </div>
                <div class="toolbar-control">
                    <label>Style</label>
                    <select id="stroke-style">
                        <option value="solid">Solid</option>
                        <option value="dashed">Dashed</option>
                        <option value="dotted">Dotted</option>
                    </select>
                </div>
                <div class="toolbar-separator"></div>
                <button id="btn-grid" class="toolbar-btn toggle-btn active" title="Toggle Grid (G)">
                    <svg width="20" height="20" viewBox="0 0 20 20"><path d="M0 5h20M0 10h20M0 15h20M5 0v20M10 0v20M15 0v20" stroke="currentColor" stroke-width="0.5" opacity="0.7"/></svg>
                </button>
                <button id="btn-snap" class="toolbar-btn toggle-btn active" title="Snap to Grid (S)">
                    <svg width="20" height="20" viewBox="0 0 20 20"><circle cx="10" cy="10" r="2" fill="currentColor"/><path d="M10 3v3M10 14v3M3 10h3M14 10h3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
                </button>
                <button id="btn-undo" class="toolbar-btn" title="Undo (Ctrl+Z)" disabled>
                    <svg width="20" height="20" viewBox="0 0 20 20"><path d="M5 10l-3-3 3-3M2 7h10a5 5 0 0 1 0 10H8" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
                <button id="btn-redo" class="toolbar-btn" title="Redo (Ctrl+Y)" disabled>
                    <svg width="20" height="20" viewBox="0 0 20 20"><path d="M15 10l3-3-3-3M18 7H8a5 5 0 0 0 0 10h4" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
            </div>
        </header>

        <!-- Main Canvas Area -->
        <main id="canvas-container">
            <canvas id="drawing-canvas"></canvas>
        </main>

        <!-- Side Panel (Layers / Properties) -->
        <aside id="side-panel" class="collapsed">
            <div class="panel-tabs">
                <button class="panel-tab active" data-panel="layers">Layers</button>
                <button class="panel-tab" data-panel="properties">Properties</button>
            </div>
            <div id="layers-panel" class="panel-content active">
                <div class="panel-header">
                    <span>Layers</span>
                    <button id="btn-add-layer" class="small-btn" title="Add Layer">+</button>
                </div>
                <div id="layer-list"></div>
            </div>
            <div id="properties-panel" class="panel-content">
                <div class="panel-header"><span>Properties</span></div>
                <div id="property-fields">
                    <p class="placeholder-text">Select an object to edit properties</p>
                </div>
            </div>
        </aside>

        <!-- Toggle Side Panel Button -->
        <button id="btn-toggle-panel" class="floating-btn" title="Toggle Panel">
            <svg width="16" height="16" viewBox="0 0 16 16"><path d="M6 3l5 5-5 5" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round"/></svg>
        </button>

        <!-- Status Bar -->
        <footer id="status-bar">
            <span id="status-coords">X: 0 Y: 0</span>
            <span id="status-zoom">100%</span>
            <span id="status-grid">Grid: 20px</span>
            <span id="status-tool">Select</span>
            <span id="status-info"></span>
        </footer>

        <!-- Menu Overlay -->
        <div id="menu-overlay" class="overlay hidden">
            <div class="menu-panel">
                <h2>FieldSketch</h2>
                <button class="menu-item" id="menu-new">New Project</button>
                <button class="menu-item" id="menu-open">Open Project</button>
                <button class="menu-item" id="menu-save">Save Project</button>
                <hr>
                <button class="menu-item" id="menu-import-image">Import Image</button>
                <button class="menu-item" id="menu-import-pdf">Import PDF</button>
                <hr>
                <button class="menu-item" id="menu-export-png">Export as PNG</button>
                <button class="menu-item" id="menu-export-pdf">Export as PDF</button>
                <hr>
                <div class="menu-section">
                    <label>Grid Size</label>
                    <select id="menu-grid-size">
                        <option value="5">5px</option>
                        <option value="10">10px</option>
                        <option value="20" selected>20px</option>
                        <option value="25">25px</option>
                        <option value="50">50px</option>
                    </select>
                </div>
                <div class="menu-section">
                    <label>Scale</label>
                    <div class="scale-control">
                        <input type="number" id="menu-scale-value" value="1" min="0.001" step="0.1">
                        <select id="menu-scale-unit">
                            <option value="px">px</option>
                            <option value="mm">mm</option>
                            <option value="cm">cm</option>
                            <option value="m">m</option>
                            <option value="in">in</option>
                            <option value="ft" selected>ft</option>
                        </select>
                        <span>per grid unit</span>
                    </div>
                </div>
                <button class="menu-item menu-close" id="menu-close">Close</button>
            </div>
        </div>

        <!-- Project Dialog -->
        <div id="project-dialog" class="overlay hidden">
            <div class="dialog-panel">
                <h3 id="dialog-title">Projects</h3>
                <div id="dialog-content"></div>
                <div class="dialog-actions">
                    <button class="btn btn-secondary" id="dialog-cancel">Cancel</button>
                    <button class="btn btn-primary" id="dialog-confirm">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PWA Install Banner -->
    <div id="install-banner" class="install-banner hidden">
        <span>Add FieldSketch to your home screen for the best experience.</span>
        <button onclick="installApp()">Install</button>
        <button onclick="dismissInstall()" class="dismiss">&times;</button>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="file-image" accept="image/*" hidden>
    <input type="file" id="file-pdf" accept=".pdf" hidden>

    <!-- PDF libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.2/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc =
                'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
    </script>

    <script type="module" src="js/app.js"></script>

    <!-- PWA install prompt -->
    <script>
        let _installPrompt = null;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            _installPrompt = e;
            const banner = document.getElementById('install-banner');
            if (banner && !localStorage.getItem('fs-install-dismissed')) {
                banner.classList.remove('hidden');
            }
        });
        function installApp() {
            if (_installPrompt) {
                _installPrompt.prompt();
                _installPrompt.userChoice.then(() => {
                    document.getElementById('install-banner').classList.add('hidden');
                    _installPrompt = null;
                });
            }
        }
        function dismissInstall() {
            document.getElementById('install-banner').classList.add('hidden');
            localStorage.setItem('fs-install-dismissed', '1');
        }
    </script>

    <!-- Service worker registration -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(() => {})
                .catch(() => {});
        }
    </script>
</body>
</html>
